##
## deploy.yml — GitHub Actions: Deploy cpanel_backup_s3.php to cPanel server
##
## Triggers on every push to main, or manually from the Actions tab.
## All sensitive values are stored as GitHub Secrets; non-sensitive as Variables.
##
## Required GitHub Secrets:
##   CPANEL_API_TOKEN  — cPanel API token
##   S3_ACCESS_KEY     — S3 access key ID
##   S3_SECRET_KEY     — S3 secret access key
##   SSH_PRIVATE_KEY   — Ed25519 private key for SSH deployment
##
## Required GitHub Variables:
##   CPANEL_HOST, CPANEL_PORT, CPANEL_USER
##   S3_ENDPOINT, S3_REGION, S3_BUCKET, S3_PATH_PREFIX
##   NOTIFY_EMAIL, MAX_BACKUPS
##   SSH_HOST, SSH_USER, SSH_PORT, DEPLOY_PATH
##

name: Deploy to cPanel Server

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger from the Actions tab

jobs:
  deploy:
    name: Substitute config and deploy via SCP
    runs-on: ubuntu-latest

    steps:
      # ── 1. Check out repository ──────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Substitute all define() constants with secrets / variables ────────
      # Sensitive values come from Secrets; non-sensitive from Variables.
      # The source file in the repo always keeps its safe placeholder values.
      # Python is used because some values contain slashes and some PHP lines
      # have trailing comments, which would confuse simpler sed patterns.
      - name: Inject configuration constants
        run: |
          python3 - <<'PYEOF'
          import re, sys

          # Map of constant name → replacement value.
          # Quotes in the value are already handled by the regex below.
          replacements = {
              # --- string constants (value wrapped in single quotes) ---
              "CPANEL_HOST"     : "${{ vars.CPANEL_HOST }}",
              "CPANEL_USER"     : "${{ vars.CPANEL_USER }}",
              "CPANEL_API_TOKEN": "${{ secrets.CPANEL_API_TOKEN }}",
              "S3_ENDPOINT"     : "${{ vars.S3_ENDPOINT }}",
              "S3_REGION"       : "${{ vars.S3_REGION }}",
              "S3_BUCKET"       : "${{ vars.S3_BUCKET }}",
              "S3_ACCESS_KEY"   : "${{ secrets.S3_ACCESS_KEY }}",
              "S3_SECRET_KEY"   : "${{ secrets.S3_SECRET_KEY }}",
              "S3_PATH_PREFIX"  : "${{ vars.S3_PATH_PREFIX }}",
              "NOTIFY_EMAIL"    : "${{ vars.NOTIFY_EMAIL }}",
          }
          # Map of constant name → replacement value for bare-integer constants.
          int_replacements = {
              "CPANEL_PORT": "${{ vars.CPANEL_PORT }}",
              "MAX_BACKUPS": "${{ vars.MAX_BACKUPS }}",
          }

          filename = "cpanel_backup_s3.php"
          with open(filename, "r") as f:
              content = f.read()

          # Replace string constants: define('NAME', '<old-value>') → define('NAME', '<new-value>')
          # The pattern matches only the quoted portion, preserving trailing comments.
          for name, value in replacements.items():
              pattern = r"(define\('" + re.escape(name) + r"',\s*')[^']*(')"
              replacement = r"\g<1>" + value.replace("\\", "\\\\") + r"\g<2>"
              content, n = re.subn(pattern, replacement, content)
              if n == 0:
                  print(f"WARNING: no match found for {name}", file=sys.stderr)

          # Replace integer constants: define('NAME', <old-int>) → define('NAME', <new-int>)
          for name, value in int_replacements.items():
              pattern = r"(define\('" + re.escape(name) + r"',\s*)\d+(\s*\))"
              replacement = r"\g<1>" + value + r"\g<2>"
              content, n = re.subn(pattern, replacement, content)
              if n == 0:
                  print(f"WARNING: no match found for {name}", file=sys.stderr)

          with open(filename, "w") as f:
              f.write(content)

          print("Configuration constants injected successfully.")
          PYEOF

      # ── 3. Verify substitution (masked in logs for secret values) ────────────
      - name: Verify injected constants (non-secret lines only)
        run: |
          grep "define('CPANEL_HOST'" cpanel_backup_s3.php
          grep "define('CPANEL_PORT'" cpanel_backup_s3.php
          grep "define('CPANEL_USER'" cpanel_backup_s3.php
          grep "define('S3_ENDPOINT'" cpanel_backup_s3.php
          grep "define('S3_REGION'"   cpanel_backup_s3.php
          grep "define('S3_BUCKET'"   cpanel_backup_s3.php
          grep "define('S3_PATH_PREFIX'" cpanel_backup_s3.php
          grep "define('NOTIFY_EMAIL'"  cpanel_backup_s3.php
          grep "define('MAX_BACKUPS'"   cpanel_backup_s3.php

      # ── 4. Deploy file to cPanel server via SCP ──────────────────────────────
      - name: Deploy via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USER }}
          port:     ${{ vars.SSH_PORT }}
          key:      ${{ secrets.SSH_PRIVATE_KEY }}
          source:   cpanel_backup_s3.php
          target:   /home/${{ vars.SSH_USER }}/

      # ── 5. Set restrictive permissions on deployed file ──────────────────────
      - name: Set file permissions (600)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host:     ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USER }}
          port:     ${{ vars.SSH_PORT }}
          key:      ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            chmod 600 ${{ vars.DEPLOY_PATH }}
            echo "Deployed: $(ls -lh ${{ vars.DEPLOY_PATH }})"
